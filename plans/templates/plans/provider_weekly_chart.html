{% extends "plans/base.html" %}

{% block content %}
<h2>{{ plan.provider_name }} - {{ plan.plan_name }} Price Trend</h2>

<!-- Display plan description separately -->
<p>{{ plan.description }}</p>

<!-- Time Range Selector -->
<div>
    <label for="timeRange">Select Time Range: </label>
    <select id="timeRange">
        <option value="7">Weekly</option>
        <option value="10">10 Days</option>
        <option value="15">15 Days</option>
        <option value="30">1 Month</option>
        <option value="90">3 Months</option>
        <option value="180">6 Months</option>
        <option value="365">1 Year</option>
    </select>
</div>

<!-- Chart Canvas -->
<canvas id="priceChart" width="800" height="400" style="margin-top:20px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const fullChartData = JSON.parse('{{ chart_data_json|escapejs }}');
    const ctx = document.getElementById('priceChart').getContext('2d');

    function filterData(days) {
        const total = fullChartData.labels.length;
        const start = Math.max(total - days, 0);
        return {
            labels: fullChartData.labels.slice(start),
            prices: fullChartData.prices.slice(start)
        };
    }

    let chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: fullChartData.labels,
            datasets: [{
                label: '{{ plan.plan_name }} Price',
                data: fullChartData.prices,
                borderColor: 'blue',
                backgroundColor: 'rgba(0,0,255,0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                tooltip: { mode: 'index' }
            },
            scales: {
                x: { display: true, title: { display: true, text: 'Date/Time' } },
                y: { display: true, title: { display: true, text: 'Price ($)' } }
            }
        }
    });

    document.getElementById('timeRange').addEventListener('change', function() {
        const days = parseInt(this.value);
        const filtered = filterData(days);
        chart.data.labels = filtered.labels;
        chart.data.datasets[0].data = filtered.prices;
        chart.update();
    });
</script>

{% endblock %}
